<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Jurídico Completo</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/727/727399.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        /* =================== VISUAL APRIMORADO v2 =================== */
        :root {
            --cor-vinho: #5D1A2A;
            --cor-dourado: #D4AF37;
            --cor-dourado-hover: #c09b2d;
            --cor-bege-claro: #F3EAD3;
            --cor-bege-fundo: #EFEBE0;
            --cor-texto-escuro: #3d2c21;

            /* Mapeamento para o tema antigo */
            --main: var(--cor-vinho);
            --accent: var(--cor-dourado);
            --accent-light: var(--cor-bege-claro);
            --danger: #ef4444;
            /* Mantendo um vermelho para perigo */
            --success: #10b981;
            /* Mantendo um verde para sucesso */
            --info: #0ea5e9;
            /* Mantendo um azul para informação */
            --warning: #f59e0b;
            /* Mantendo um laranja para aviso */
            --bg: var(--cor-bege-fundo);
            --white: #ffffff;
            --border: #ddd3bb;
            --dark-text: var(--cor-texto-escuro);
            --muted-text: #8c7a6b;
            --radius: 1rem;
            --shadow: 0 4px 18px rgba(0, 0, 0, .08);
            --transition: .2s ease-in-out;
            font-family: 'Inter', system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--dark-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        header {
            background: var(--main);
            color: var(--white);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            gap: 1.5rem;
        }

        header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--cor-bege-claro);
            flex-shrink: 0;
            /* Impede que o título encolha */
        }

        nav {
            flex-grow: 1;
            /* Faz o menu ocupar o espaço disponível */
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            justify-content: center;
            /* Centraliza os botões do menu */
        }

        nav button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(243, 234, 211, 0.3);
            color: var(--cor-bege-claro);
            padding: .6rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: .7rem;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav button:hover {
            background: var(--cor-dourado);
            border-color: var(--cor-dourado-hover);
            color: var(--cor-texto-escuro);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        nav button.active {
            background: var(--cor-dourado);
            border-color: var(--cor-dourado);
            color: var(--cor-texto-escuro);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        nav button:active {
            transform: scale(0.97);
            transition: transform .1s ease;
        }

        /* Adiciona uma regra para o botão de logout */
        header>button.btn {
            margin-left: auto;
            /* Empurra o botão para a direita */
            flex-shrink: 0;
            /* Impede que o botão encolha */
        }

        .btn {
            background: var(--accent);
            color: var(--cor-texto-escuro);
            border: none;
            padding: .75rem 1.5rem;
            font-size: .95rem;
            font-weight: 600;
            border-radius: .7rem;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--cor-dourado-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, .3);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 44px 12px rgba(16, 185, 129, .4);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, .4);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background: #0284c7;
            box-shadow: 0 4px 12px rgba(14, 165, 233, .4);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 2rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn .4s;
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-header h2 {
            font-size: 1.8rem;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            flex-grow: 1;
            min-width: 200px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: .9rem 1rem;
            font-size: .98rem;
            border: 1.5px solid var(--border);
            border-radius: .65rem;
            background: var(--cor-bege-claro);
            transition: all var(--transition);
            font-family: 'Inter', sans-serif;
            color: var(--cor-texto-escuro);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--cor-dourado-hover-transparente, #c09b2d55);
            outline: none;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: .5rem;
            font-size: .9rem;
        }

        #login-panel {
            max-width: 400px;
            margin: 10vh auto;
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        #login-panel h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--main);
        }

        #login-erro {
            color: var(--danger);
            margin-top: 1rem;
            font-size: .9rem;
            display: none;
        }

        #painel-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        #resumo-financeiro.painel-cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
            /* Aumentando o espaçamento */
        }

        #resumo-financeiro.painel-cards .card {
            flex: 0 1 260px;
            /* Impede que os cards estiquem demais */
            min-width: 220px;
        }

        .card {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: .5rem;
            transition: all var(--transition);
            border: 1px solid #ddd3bb;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .1);
            border-color: var(--accent);
        }

        .card .icon {
            font-size: 1.8rem;
            color: var(--main);
        }

        .card .value {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .card .label {
            color: var(--muted-text);
            font-weight: 500;
        }

        .chart-container {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2.5rem;
        }

        #painel-prazos ul {
            list-style: none;
            padding: 1rem 0;
        }

        #painel-prazos li {
            background: var(--accent-light);
            padding: .8rem 1.2rem;
            border-radius: .8rem;
            margin-bottom: .5rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .table-wrapper {
            overflow-x: auto;
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem 1.2rem;
            text-align: left;
            font-size: .95rem;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: #f9fafb;
            color: var(--muted-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: .8rem;
            background: transparent;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--cor-bege-fundo);
        }

        td .actions {
            display: flex;
            gap: .5rem;
        }

        td .actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--muted-text);
            padding: .3rem;
            transition: color var(--transition);
        }

        td .actions button:hover {
            color: var(--accent);
        }

        .badge {
            display: inline-block;
            padding: .3rem .8rem;
            border-radius: 99px;
            font-size: .8rem;
            font-weight: 600;
            color: var(--cor-texto-escuro);
            text-align: center;
        }

        .badge.Ativo,
        .badge.Agendado {
            background: var(--accent);
        }

        .badge.Concluído,
        .badge.Concluída,
        .badge.Realizado,
        .badge.Pago {
            background: var(--success);
            color: var(--white);
        }

        .badge.Arquivado,
        .badge.Cancelado {
            background: var(--muted-text);
            color: var(--white);
        }

        .badge.Pendente,
        .badge.Vencido {
            background: var(--warning);
        }

        .badge.Alta {
            background: var(--danger);
            color: var(--white);
        }

        .badge.Média {
            background: var(--warning);
        }

        .badge.Baixa {
            background: var(--info);
            color: var(--white);
        }

        .badge.Receber {
            background: var(--success);
            color: var(--white);
        }

        .badge.Pagar {
            background: var(--danger);
            color: var(--white);
        }

        .modal-bg {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(61, 44, 33, .5);
            backdrop-filter: blur(4px);
            z-index: 999;
            animation: fadeIn .3s;
        }

        .modal-bg.active {
            display: flex;
        }

        .modal {
            background: var(--cor-bege-fundo);
            border-radius: var(--radius);
            padding: 2rem 2.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .1);
            animation: scaleIn .3s;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--muted-text);
            cursor: pointer;
            line-height: 1;
        }

        .modal-footer {
            margin-top: 2rem;
            text-align: right;
        }

        #notificacoes {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 320px;
        }

        .notif {
            background: var(--cor-bege-claro);
            border-left: 5px solid var(--accent);
            padding: 1rem 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border-radius: .8rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
            margin-bottom: 1rem;
            animation: slideIn .4s forwards;
            transform: translateX(120%);
            color: var(--cor-texto-escuro);
        }

        .notif.success {
            border-left-color: var(--success);
        }

        .notif.danger {
            border-left-color: var(--danger);
        }

        .notif i {
            font-size: 1.4rem;
            opacity: .8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }

        @media(max-width: 800px) {

            .filter-bar,
            .section-header {
                flex-direction: column;
                padding: 1rem;
                align-items: stretch;
            }

            nav {
                justify-content: flex-start;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            .modal {
                padding: 1.5rem;
            }

            .table-wrapper {
                box-shadow: none;
            }

            table {
                box-shadow: var(--shadow);
            }

            thead {
                display: none;
            }

            tr {
                display: block;
                margin-bottom: 1rem;
                border-radius: .8rem;
                overflow: hidden;
                box-shadow: var(--shadow);
                background: var(--cor-bege-claro);
            }

            td {
                display: block;
                text-align: right;
                position: relative;
                padding-left: 50%;
                border: none;
                border-bottom: 1px solid var(--border);
            }

            td:before {
                content: attr(data-label);
                position: absolute;
                left: 1rem;
                width: calc(50% - 2rem);
                text-align: left;
                font-weight: 600;
                color: var(--main);
            }

            td:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>

<body>

    <div id="login-panel">
        <h2><i class="fa-solid fa-scale-balanced"></i> Login do Advogado</h2>
        <div class="form-group">
            <input id="login-usuario" type="text" placeholder="Usuário" required>
        </div>
        <div class="form-group">
            <input id="login-senha" type="password" placeholder="Senha" required>
        </div>
        <button id="btnLogin" class="btn" style="width: 100%;">Entrar</button>
        <div id="login-erro">Usuário ou senha incorretos.</div>
        <p style="text-align:center; margin-top:1.8rem; font-size:.9rem; color:#666;">
            Primeiro acesso? <a href="#" onclick="criarConta()" style="color:var(--accent); font-weight:600;">Criar
                conta</a>
        </p>
    </div>

    <div id="app" style="display:none">
        <header>
            <h1><i class="fa-solid fa-scale-balanced" style="color: var(--success);"></i> Painel Jurídico</h1>
            <nav>
                <button id="nav0" class="active" onclick="abrirTab(0)"><i class="fa fa-chart-pie"></i> Painel</button>
                <button id="nav1" onclick="abrirTab(1)"><i class="fa fa-briefcase"></i> Casos</button>
                <button id="nav2" onclick="abrirTab(2)"><i class="fa fa-users"></i> Clientes</button>
                <button id="nav3" onclick="abrirTab(3)"><i class="fa fa-folder-open"></i> Documentos</button>
                <button id="nav4" onclick="abrirTab(4)"><i class="fa fa-calendar-alt"></i> Agenda</button>
                <button id="nav5" onclick="abrirTab(5)"><i class="fa fa-tasks"></i> Tarefas</button>
                <button id="nav6" onclick="abrirTab(6)"><i class="fa fa-hand-holding-dollar"></i> Financeiro</button>
                <button id="nav7" onclick="abrirTab(7)"><i class="fa fa-file-alt"></i> Relatórios</button>
            </nav>
            <button onclick="logout()" class="btn" style="background: #fff1f3; color:#d43c5e;">Sair <i
                    class="fa fa-sign-out-alt"></i></button>
        </header>

        <main class="container">
            <div id="notificacoes"></div>

            <!-- TAB: PAINEL GERAL -->
            <div class="tab-content active" id="tab0">
                <div class="section-header">
                    <h2>Visão Geral</h2>
                </div>
                <div id="painel-cards"></div>
                <div class="chart-container"><canvas id="chart-overview"></canvas></div>
                <h3>Prazos Críticos Próximos</h3>
                <div id="painel-prazos"></div>
            </div>

            <!-- TAB: CASOS -->
            <div class="tab-content" id="tab1">
                <div class="section-header">
                    <h2>Casos & Processos</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-caso" type="text" placeholder="Buscar por nº do processo, cliente, partes…"
                        onkeyup="renderCasos()">
                    <select id="filtro-caso-status" onchange="renderCasos()">
                        <option value="">Todos os Status</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Arquivado">Arquivado</option>
                    </select>
                    <button class="btn btn-success" onclick="abrirModalCaso()"><i class="fa fa-plus"></i> Novo
                        Caso</button>
                </div>
                <div class="table-wrapper" id="tabela-casos"></div>
            </div>

            <!-- TAB: CLIENTES -->
            <div class="tab-content" id="tab2">
                <div class="section-header">
                    <h2>Clientes</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-cliente" type="text" placeholder="Buscar por nome, e-mail, telefone…"
                        onkeyup="renderClientes()">
                    <button class="btn btn-success" onclick="abrirModalCliente()"><i class="fa fa-plus"></i> Novo
                        Cliente</button>
                </div>
                <div class="table-wrapper" id="tabela-clientes"></div>
            </div>

            <!-- TAB: DOCUMENTOS -->
            <div class="tab-content" id="tab3">
                <div class="section-header">
                    <h2>Gestão de Documentos</h2>
                </div>
                <div class="filter-bar">
                    <select id="doc-filtro-cliente" onchange="renderDocumentos()">
                        <option value="">Filtrar por cliente</option>
                    </select>
                    <select id="doc-filtro-caso" onchange="renderDocumentos()">
                        <option value="">Filtrar por caso</option>
                    </select>
                    <button class="btn btn-success" onclick="abrirModalDocumento()"><i class="fa fa-upload"></i> Anexar
                        Documento</button>
                </div>
                <div class="table-wrapper" id="tabela-documentos"></div>
            </div>

            <!-- TAB: AGENDA -->
            <div class="tab-content" id="tab4">
                <div class="section-header">
                    <h2>Agenda & Prazos</h2>
                    <button class="btn btn-success" onclick="abrirModalEvento()"><i class="fa fa-calendar-plus"></i>
                        Novo Evento</button>
                </div>
                <div class="filter-bar">
                    <input id="agenda-filtro-data" type="date" onchange="renderAgenda()">
                    <select id="agenda-filtro-tipo" onchange="renderAgenda()">
                        <option value="">Todos os Tipos</option>
                        <option>Audiência</option>
                        <option>Reunião</option>
                        <option>Prazo Processual</option>
                        <option>Outro</option>
                    </select>
                </div>
                <div class="table-wrapper" id="tabela-agenda"></div>
            </div>

            <!-- TAB: TAREFAS -->
            <div class="tab-content" id="tab5">
                <div class="section-header">
                    <h2>Controle de Tarefas</h2>
                    <button class="btn btn-success" onclick="abrirModalTarefa()"><i class="fa fa-plus"></i> Nova
                        Tarefa</button>
                </div>
                <div class="filter-bar">
                    <select id="filtro-tarefa-status" onchange="renderTarefas()">
                        <option value="Pendente">Pendentes</option>
                        <option value="">Todas</option>
                        <option value="Concluída">Concluídas</option>
                    </select>
                    <select id="filtro-tarefa-prioridade" onchange="renderTarefas()">
                        <option value="">Todas as Prioridades</option>
                        <option>Alta</option>
                        <option>Média</option>
                        <option>Baixa</option>
                    </select>
                </div>
                <div class="table-wrapper" id="tabela-tarefas"></div>
            </div>

            <!-- TAB: FINANCEIRO -->
            <div class="tab-content" id="tab6">
                <div class="section-header">
                    <h2>Financeiro</h2>
                </div>
                <div id="resumo-financeiro" class="painel-cards"></div>

                <div class="section-header" style="margin-top: 2.5rem; margin-bottom: 1rem;">
                    <h3 style="font-size: 1.5rem;">Histórico de Lançamentos</h3>
                    <div class="filter-bar" style="margin-bottom: 0;">
                        <button class="btn btn-success" onclick="abrirModalFin('Receber')"><i class="fa fa-plus"></i>
                            Nova Receita</button>
                        <button class="btn btn-danger" onclick="abrirModalFin('Pagar')"><i class="fa fa-minus"></i> Nova
                            Despesa</button>
                    </div>
                </div>
                <div class="table-wrapper" id="tabela-financeiro"></div>
            </div>

            <!-- TAB: RELATÓRIOS -->
            <div class="tab-content" id="tab7">
                <div class="section-header">
                    <h2>Relatórios & Métricas</h2>
                </div>
                <div class="chart-container"><canvas id="chart-relatorio"></canvas></div>
                <button class="btn btn-info" onclick="exportarCSV('fin')"><i class="fa fa-file-csv"></i> Exportar
                    Financeiro (CSV)</button>
            </div>
        </main>
    </div>

    <!-- ========= MODAIS ========= -->
    <div class="modal-bg" id="modal-caso">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-caso-titulo">Novo Caso</h3><button class="close-modal"
                    onclick="fecharModal('modal-caso')">&times;</button>
            </div>
            <form onsubmit="salvarCaso(); return false;">
                <input type="hidden" id="caso-id">
                <div class="form-group"><label for="caso-cliente">Cliente *</label><select id="caso-cliente"
                        required></select></div>
                <div class="form-group"><label for="caso-numero">Nº do Processo *</label><input id="caso-numero"
                        type="text" maxlength="60" required></div>
                <div class="form-group"><label for="caso-partes">Partes Envolvidas</label><textarea id="caso-partes"
                        placeholder="Autor, réu, terceiro..." rows="3"></textarea></div>
                <div class="form-group"><label for="caso-responsavel">Advogado Responsável</label><input
                        id="caso-responsavel" type="text"></div>
                <div class="form-group"><label for="caso-data">Data de Abertura</label><input id="caso-data"
                        type="date">
                </div>
                <div class="form-group"><label for="caso-status">Status</label><select id="caso-status">
                        <option>Ativo</option>
                        <option>Concluído</option>
                        <option>Arquivado</option>
                    </select></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-cliente">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="modal-cliente-titulo">Novo Cliente</h3><button class="close-modal"
                    onclick="fecharModal('modal-cliente')">&times;</button>
            </div>
            <form onsubmit="salvarCliente(); return false;">
                <input type="hidden" id="cliente-id">
                <div class="form-group"><label for="cliente-nome">Nome Completo *</label><input id="cliente-nome"
                        type="text" required></div>
                <div class="form-group"><label for="cliente-email">E-mail</label><input id="cliente-email" type="email">
                </div>
                <div class="form-group"><label for="cliente-fone">Telefone</label><input id="cliente-fone" type="tel">
                </div>
                <div class="form-group"><label for="cliente-notas">Anotações / Preferências</label><textarea
                        id="cliente-notas" rows="4"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-documento">
        <div class="modal">
            <div class="modal-header">
                <h3>Anexar Documento</h3><button class="close-modal"
                    onclick="fecharModal('modal-documento')">&times;</button>
            </div>
            <form onsubmit="salvarDocumento(); return false;">
                <p style="font-size: .85rem; color: var(--muted-text); margin-bottom: 1rem;">Anexe arquivos a um cliente
                    ou
                    caso. Os arquivos são salvos no seu navegador e não em um servidor externo.</p>
                <input type="hidden" id="doc-id">
                <div class="form-group"><label for="doc-cliente">Cliente *</label><select id="doc-cliente"
                        required></select></div>
                <div class="form-group"><label for="doc-caso">Vincular ao Caso (opcional)</label><select
                        id="doc-caso"></select></div>
                <div class="form-group"><label for="doc-titulo">Título / Descrição *</label><input id="doc-titulo"
                        type="text" required></div>
                <div class="form-group"><label for="doc-file">Arquivo *</label><input id="doc-file" type="file"
                        accept=".pdf,.doc,.docx,.jpg,.png,.jpeg,.xls,.xlsx" required></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL EVENTO -->
    <div class="modal-bg" id="modal-evento">
        <div class="modal">
            <div class="modal-header">
                <h3 id="evento-modal-titulo">Novo Evento / Prazo</h3><button class="close-modal"
                    onclick="fecharModal('modal-evento')">&times;</button>
            </div>
            <form onsubmit="salvarEvento(); return false;">
                <input type="hidden" id="evento-id">
                <div class="form-group"><label for="evento-titulo">Título *</label><input id="evento-titulo" type="text"
                        required></div>
                <div class="form-group"><label for="evento-tipo">Tipo de Evento *</label><select id="evento-tipo"
                        required>
                        <option>Audiência</option>
                        <option>Reunião</option>
                        <option>Prazo Processual</option>
                        <option>Outro</option>
                    </select></div>
                <div class="form-group"><label for="evento-datahora">Data e Hora *</label><input id="evento-datahora"
                        type="datetime-local" required></div>
                <div class="form-group"><label for="evento-local">Local / Link</label><input id="evento-local"
                        type="text" placeholder="Ex: Fórum Central, link da chamada..."></div>
                <div class="form-group"><label for="evento-cliente">Vincular ao Cliente</label><select
                        id="evento-cliente"
                        onchange="populateSelect('evento-caso', `SELECT id, numero FROM casos WHERE cliente_id=${this.value} ORDER BY id DESC`, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="evento-caso">Vincular ao Caso</label><select
                        id="evento-caso"></select></div>
                <div class="form-group"><label for="evento-status">Status</label><select id="evento-status">
                        <option>Agendado</option>
                        <option>Realizado</option>
                        <option>Cancelado</option>
                    </select></div>
                <div class="form-group"><label for="evento-desc">Descrição</label><textarea id="evento-desc"
                        rows="3"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL TAREFA -->
    <div class="modal-bg" id="modal-tarefa">
        <div class="modal">
            <div class="modal-header">
                <h3 id="tarefa-modal-titulo">Nova Tarefa</h3><button class="close-modal"
                    onclick="fecharModal('modal-tarefa')">&times;</button>
            </div>
            <form onsubmit="salvarTarefa(); return false;">
                <input type="hidden" id="tarefa-id">
                <div class="form-group"><label for="tarefa-desc">Descrição *</label><textarea id="tarefa-desc" rows="3"
                        required></textarea></div>
                <div class="form-group"><label for="tarefa-prioridade">Prioridade</label><select id="tarefa-prioridade">
                        <option>Baixa</option>
                        <option>Média</option>
                        <option>Alta</option>
                    </select></div>
                <div class="form-group"><label for="tarefa-prazo">Data do Prazo</label><input id="tarefa-prazo"
                        type="date"></div>
                <div class="form-group"><label for="tarefa-cliente">Vincular ao Cliente</label><select
                        id="tarefa-cliente"
                        onchange="populateSelect('tarefa-caso', `SELECT id, numero FROM casos WHERE cliente_id=${this.value} ORDER BY id DESC`, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="tarefa-caso">Vincular ao Caso</label><select
                        id="tarefa-caso"></select></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL FINANCEIRO -->
    <div class="modal-bg" id="modal-fin">
        <div class="modal">
            <div class="modal-header">
                <h3 id="fin-titulo">Novo Lançamento</h3><button class="close-modal"
                    onclick="fecharModal('modal-fin')">&times;</button>
            </div>
            <form onsubmit="salvarFin(); return false;">
                <input type="hidden" id="fin-id"><input type="hidden" id="fin-tipo">
                <div class="form-group"><label for="fin-desc">Descrição *</label><input id="fin-desc" type="text"
                        required></div>
                <div class="form-group"><label for="fin-categoria">Categoria *</label><select id="fin-categoria"
                        required>
                        <option>Honorários</option>
                        <option>Custas Processuais</option>
                        <option>Acordo</option>
                        <option>Serviços de Terceiros</option>
                        <option>Despesas Gerais</option>
                        <option>Outra</option>
                    </select></div>
                <div class="form-group"><label for="fin-valor">Valor (R$) *</label><input id="fin-valor" type="number"
                        step="0.01" placeholder="Ex: 1500.50" required></div>
                <div class="form-group"><label for="fin-data">Data *</label><input id="fin-data" type="date" required>
                </div>
                <div class="form-group"><label for="fin-status">Status Pagamento</label><select id="fin-status">
                        <option>Pendente</option>
                        <option>Pago</option>
                        <option>Vencido</option>
                    </select></div>
                <div class="form-group"><label for="fin-cliente">Vincular ao Cliente</label><select id="fin-cliente"
                        onchange="populateSelect('fin-caso', `SELECT id, numero FROM casos WHERE cliente_id=${this.value} ORDER BY id DESC`, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="fin-caso">Vincular ao Caso</label><select id="fin-caso"></select>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // =================================================================================
        // PAINEL JURÍDICO - SCRIPT COMPLETO (Versão LocalStorage)
        // =================================================================================

        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        /* ------------- SEGURANÇA / LOGIN ------------- */
        const KEY_USER = "advUser_v3", KEY_PASS = "advPass_v3", DB_KEY = "dbData_v4";

        function criarConta() {
            const u = prompt("Crie um nome de usuário:");
            if (!u) return;
            const p = prompt("Crie uma senha:");
            if (!p) return;
            localStorage.setItem(KEY_USER, btoa(u));
            localStorage.setItem(KEY_PASS, btoa(p));
            alert("Conta criada com sucesso! Agora você pode fazer o login.");
        }

        function checkLogin() {
            if (btoa($('#login-usuario').value) === localStorage.getItem(KEY_USER) && btoa($('#login-senha').value) === localStorage.getItem(KEY_PASS)) {
                $('#login-panel').style.display = "none";
                $('#app').style.display = "block";
                showNotif("success", "Login efetuado com sucesso!");
                initDB();
            } else {
                $('#login-erro').style.display = "block";
            }
        }
        $('#btnLogin').addEventListener('click', checkLogin);
        $('#login-senha').addEventListener('keypress', (e) => e.key === 'Enter' && checkLogin());

        function logout() { if (confirm("Deseja realmente sair?")) location.reload(); }

        /* ------------- BANCO DE DADOS (sql.js) ------------- */
        let db, SQL;
        async function initDB() {
            try {
                SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
                const dbData = localStorage.getItem(DB_KEY);
                if (dbData) {
                    db = new SQL.Database(new Uint8Array(JSON.parse(dbData)));
                } else {
                    db = new SQL.Database();
                    const schema = `
                    CREATE TABLE clientes(id INTEGER PRIMARY KEY, nome TEXT, email TEXT, fone TEXT, notas TEXT);
                    CREATE TABLE casos(id INTEGER PRIMARY KEY, cliente_id INTEGER, numero TEXT, partes TEXT, responsavel TEXT, data TEXT, status TEXT);
                    CREATE TABLE docs(id INTEGER PRIMARY KEY, cliente_id INTEGER, caso_id INTEGER, titulo TEXT, arquivo TEXT, nome_arquivo TEXT, tipo_arquivo TEXT, data TEXT);
                    CREATE TABLE agenda(id INTEGER PRIMARY KEY, cliente_id INTEGER, caso_id INTEGER, titulo TEXT, datahora TEXT, status TEXT, descricao TEXT, tipo_evento TEXT, local TEXT);
                    CREATE TABLE tarefas(id INTEGER PRIMARY KEY, desc TEXT, status TEXT, prioridade TEXT, prazo_data TEXT, cliente_id INTEGER, caso_id INTEGER);
                    CREATE TABLE fin(id INTEGER PRIMARY KEY, tipo TEXT, valor REAL, data TEXT, descricao TEXT, categoria TEXT, status_pg TEXT, cliente_id INTEGER, caso_id INTEGER);
                `;
                    db.run(schema);
                    persist();
                }
                renderAll();
            } catch (err) {
                console.error("Erro ao inicializar o banco de dados:", err);
                showNotif('danger', 'Não foi possível carregar o banco de dados.');
            }
        }

        function persist() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(Array.from(db.export())));
            } catch (e) {
                console.error("Erro ao salvar no localStorage:", e);
                showNotif('danger', 'Erro ao salvar dados. Verifique o espaço livre.');
            }
        }

        /* ------------- UI & NAVEGAÇÃO ------------- */
        const renderFunctions = [loadDashboard, renderCasos, renderClientes, renderDocumentos, renderAgenda, renderTarefas, loadFinanceiro, loadRelatorios];
        function abrirTab(index) {
            $$('nav button').forEach(b => b.classList.remove('active'));
            $(`#nav${index}`).classList.add('active');
            $$('.tab-content').forEach(t => t.classList.remove('active'));
            $(`#tab${index}`).classList.add('active');
            if (renderFunctions[index]) renderFunctions[index]();
        }

        function showNotif(type, msg) {
            const icons = { success: 'fa-check-circle', danger: 'fa-times-circle' };
            const div = document.createElement('div');
            div.className = `notif ${type}`;
            div.innerHTML = `<i class="fa ${icons[type]}"></i><span>${msg}</span>`;
            $('#notificacoes').appendChild(div);
            setTimeout(() => {
                div.style.animation = 'slideOut .4s forwards';
                setTimeout(() => div.remove(), 400);
            }, 4000);
        }

        function fecharModal(modalId) { $(`#${modalId}`).classList.remove('active'); }

        function delRow(table, id, renderCallback) {
            if (confirm("Tem certeza que deseja excluir este registro? A ação não pode ser desfeita.")) {
                db.run(`DELETE FROM ${table} WHERE id=?`, [id]);
                persist();
                showNotif('success', 'Registro excluído.');
                if (renderCallback) renderCallback();
            }
        }

        /* ------------- HELPERS ------------- */
        const single = (q, p = []) => db.exec(q, p)[0]?.values[0]?.[0] || 0;
        const getRow = (q, p = []) => db.exec(q, p)[0]?.values[0] || null;
        const fmtDate = (d) => d ? new Date(d).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
        const fmtDateTime = (d) => d ? new Date(d).toLocaleString('pt-BR', { timeZone: 'UTC' }) : '';
        const fmtCurrency = (v) => Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        function populateSelect(selectId, query, placeholder, selectedValue = null) {
            const select = $(`#${selectId}`);
            select.innerHTML = `<option value="">${placeholder}</option>`;
            const rows = db.exec(query)[0]?.values || [];
            rows.forEach(r => select.innerHTML += `<option value="${r[0]}">${r[1]}</option>`);
            if(selectedValue) select.value = selectedValue;
        }

        /* ------------- MÓDULOS (CRUD e RENDER) ------------- */

        // --- PAINEL GERAL (TAB 0) ---
        let overviewChart;
        function loadDashboard() {
            $('#painel-cards').innerHTML = `
            <div class="card"><i class="icon fa fa-briefcase"></i><div class="value">${single(`SELECT count(*) FROM casos WHERE status='Ativo'`)}</div><div class="label">Casos Ativos</div></div>
            <div class="card"><i class="icon fa fa-users"></i><div class="value">${single(`SELECT count(*) FROM clientes`)}</div><div class="label">Total de Clientes</div></div>
            <div class="card"><i class="icon fa fa-calendar-day"></i><div class="value">${single(`SELECT count(*) FROM agenda WHERE date(datahora) = date('now', 'localtime')`)}</div><div class="label">Prazos para Hoje</div></div>
            <div class="card"><i class="icon fa fa-tasks"></i><div class="value">${single(`SELECT count(*) FROM tarefas WHERE status='Pendente'`)}</div><div class="label">Tarefas Pendentes</div></div>
        `;
            const prazos = db.exec("SELECT titulo, datahora FROM agenda WHERE status='Agendado' AND datahora >= datetime('now', 'localtime') ORDER BY datahora LIMIT 5")[0]?.values || [];
            $('#painel-prazos').innerHTML = prazos.length ? `<ul>${prazos.map(p => `<li><strong>${p[0]}</strong> <span>${fmtDateTime(p[1])}</span></li>`).join('')}</ul>` : "<p>Nenhum prazo futuro encontrado.</p>";
            
            const rows = db.exec(`SELECT strftime('%Y-%m', data) as mes, sum(valor) as total FROM fin WHERE tipo='Receber' AND status_pg='Pago' GROUP BY mes ORDER BY mes DESC LIMIT 6`)[0]?.values || [];
            const labels = rows.map(r => new Date(r[0] + '-02').toLocaleString('pt-BR', { month: 'short', year: '2-digit' })).reverse();
            const data = rows.map(r => r[1]).reverse();
            const ctx = $('#chart-overview').getContext('2d');
            if (overviewChart) overviewChart.destroy();
            overviewChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Faturamento Mensal', data, backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: 'rgba(99, 102, 241, 1)', borderWidth: 2, tension: 0.4, fill: true }] } });
        }

        // --- CASOS (TAB 1) ---
        function renderCasos() {
            const busca = $('#buscar-caso').value.toLowerCase();
            const status = $('#filtro-caso-status').value;
            let q = `SELECT c.id, c.numero, cl.nome, c.partes, c.status FROM casos c JOIN clientes cl ON c.cliente_id = cl.id`;
            const cond = [];
            if (status) cond.push(`c.status = '${status}'`);
            if (busca) cond.push(`(c.numero LIKE '%${busca}%' OR cl.nome LIKE '%${busca}%' OR c.partes LIKE '%${busca}%')`);
            if (cond.length) q += ' WHERE ' + cond.join(' AND ');
            q += ' ORDER BY c.id DESC';
            const rows = db.exec(q)[0]?.values || [];
            const table = $('#tabela-casos');
            if (!rows.length) { table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum caso encontrado.</p>`; return; }
            table.innerHTML = `<table><thead><tr><th>Nº Processo</th><th>Cliente</th><th>Partes</th><th>Status</th><th>Ações</th></tr></thead><tbody>
        ${rows.map(r => `<tr>
            <td data-label="Nº Processo">${r[1]}</td>
            <td data-label="Cliente">${r[2]}</td>
            <td data-label="Partes">${r[3]}</td>
            <td data-label="Status"><span class="badge ${r[4]}">${r[4]}</span></td>
            <td data-label="Ações"><div class="actions">
                <button onclick="abrirModalCaso(${r[0]})" title="Editar"><i class="fa fa-edit"></i></button>
                <button onclick="delRow('casos', ${r[0]}, renderCasos)" title="Excluir"><i class="fa fa-trash"></i></button>
            </div></td>
        </tr>`).join('')}</tbody></table>`;
        }
        function abrirModalCaso(id = null) {
            $('#modal-caso form').reset();
            $('#caso-id').value = '';
            populateSelect('caso-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Selecione um cliente');
            if (id) {
                const r = getRow(`SELECT * FROM casos WHERE id=${id}`);
                $('#modal-caso-titulo').innerText = 'Editar Caso';
                $('#caso-id').value = r[0];
                $('#caso-cliente').value = r[1];
                $('#caso-numero').value = r[2];
                $('#caso-partes').value = r[3];
                $('#caso-responsavel').value = r[4];
                $('#caso-data').value = r[5];
                $('#caso-status').value = r[6];
            } else {
                $('#modal-caso-titulo').innerText = 'Novo Caso';
                $('#caso-data').valueAsDate = new Date();
            }
            $('#modal-caso').classList.add('active');
        }
        function salvarCaso() {
            const id = $('#caso-id').value;
            const params = [$('#caso-cliente').value, $('#caso-numero').value, $('#caso-partes').value, $('#caso-responsavel').value, $('#caso-data').value, $('#caso-status').value];
            if (!params[0] || !params[1]) return showNotif('danger', 'Cliente e Nº do Processo são obrigatórios.');
            if (id) {
                db.run("UPDATE casos SET cliente_id=?, numero=?, partes=?, responsavel=?, data=?, status=? WHERE id=?", [...params, id]);
            } else {
                db.run("INSERT INTO casos (cliente_id, numero, partes, responsavel, data, status) VALUES (?, ?, ?, ?, ?, ?)", params);
            }
            persist();
            showNotif('success', 'Caso salvo!');
            fecharModal('modal-caso');
            renderCasos();
        }

        // --- CLIENTES (TAB 2) ---
        function renderClientes() {
            const busca = $('#buscar-cliente').value.toLowerCase();
            let q = `SELECT id, nome, email, fone FROM clientes`;
            if (busca) q += ` WHERE nome LIKE '%${busca}%' OR email LIKE '%${busca}%' OR fone LIKE '%${busca}%'`;
            q += ' ORDER BY nome';
            const rows = db.exec(q)[0]?.values || [];
            const table = $('#tabela-clientes');
            if (!rows.length) { table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum cliente encontrado.</p>`; return; }
            table.innerHTML = `<table><thead><tr><th>Nome</th><th>E-mail</th><th>Telefone</th><th>Ações</th></tr></thead><tbody>
        ${rows.map(r => `<tr>
            <td data-label="Nome">${r[1]}</td>
            <td data-label="E-mail">${r[2]}</td>
            <td data-label="Telefone">${r[3]}</td>
            <td data-label="Ações"><div class="actions">
                <button onclick="abrirModalCliente(${r[0]})" title="Editar"><i class="fa fa-edit"></i></button>
                <button onclick="delRow('clientes', ${r[0]}, renderClientes)" title="Excluir"><i class="fa fa-trash"></i></button>
            </div></td>
        </tr>`).join('')}</tbody></table>`;
        }
        function abrirModalCliente(id = null) {
            $('#modal-cliente form').reset();
            $('#cliente-id').value = '';
            if (id) {
                const r = getRow(`SELECT * FROM clientes WHERE id=${id}`);
                $('#modal-cliente-titulo').innerText = 'Editar Cliente';
                $('#cliente-id').value = r[0];
                $('#cliente-nome').value = r[1];
                $('#cliente-email').value = r[2];
                $('#cliente-fone').value = r[3];
                $('#cliente-notas').value = r[4];
            } else {
                $('#modal-cliente-titulo').innerText = 'Novo Cliente';
            }
            $('#modal-cliente').classList.add('active');
        }
        function salvarCliente() {
            const id = $('#cliente-id').value;
            const params = [$('#cliente-nome').value, $('#cliente-email').value, $('#cliente-fone').value, $('#cliente-notas').value];
            if (!params[0]) return showNotif('danger', 'O nome do cliente é obrigatório.');
            if (id) {
                db.run("UPDATE clientes SET nome=?, email=?, fone=?, notas=? WHERE id=?", [...params, id]);
            } else {
                db.run("INSERT INTO clientes (nome, email, fone, notas) VALUES (?, ?, ?, ?)", params);
            }
            persist();
            showNotif('success', 'Cliente salvo!');
            fecharModal('modal-cliente');
            renderClientes();
        }

        // --- DOCUMENTOS (TAB 3) ---
        function renderDocumentos() {
            const clienteId = $('#doc-filtro-cliente').value;
            const casoId = $('#doc-filtro-caso').value;
            let q = `SELECT d.id, d.titulo, c.nome, ca.numero, d.data, d.nome_arquivo FROM docs d LEFT JOIN clientes c ON d.cliente_id=c.id LEFT JOIN casos ca ON d.caso_id=ca.id`;
            const cond = [];
            if (clienteId) cond.push(`d.cliente_id = ${clienteId}`);
            if (casoId) cond.push(`d.caso_id = ${casoId}`);
            if (cond.length) q += ' WHERE ' + cond.join(' AND ');
            q += ' ORDER BY d.id DESC';
            const rows = db.exec(q)[0]?.values || [];
            const table = $('#tabela-documentos');
            if (!rows.length) { table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum documento encontrado.</p>`; return; }
            table.innerHTML = `<table><thead><tr><th>Título</th><th>Cliente</th><th>Caso</th><th>Data</th><th>Arquivo</th><th>Ações</th></tr></thead><tbody>
        ${rows.map(r => `<tr>
            <td data-label="Título">${r[1]}</td>
            <td data-label="Cliente">${r[2] || 'N/A'}</td>
            <td data-label="Caso">${r[3] || 'N/A'}</td>
            <td data-label="Data">${fmtDate(r[4])}</td>
            <td data-label="Arquivo">${r[5]}</td>
            <td data-label="Ações"><div class="actions">
                <button onclick="downloadDoc(${r[0]})" title="Baixar"><i class="fa fa-download"></i></button>
                <button onclick="delRow('docs', ${r[0]}, renderDocumentos)" title="Excluir"><i class="fa fa-trash"></i></button>
            </div></td>
        </tr>`).join('')}</tbody></table>`;
        }
        function abrirModalDocumento() {
            $('#modal-documento form').reset();
            populateSelect('doc-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Selecione um cliente');
            populateSelect('doc-caso', 'SELECT id, numero FROM casos ORDER BY id DESC', 'Nenhum');
            $('#modal-documento').classList.add('active');
        }
        function salvarDocumento() {
            const file = $('#doc-file').files[0];
            const titulo = $('#doc-titulo').value;
            const clienteId = $('#doc-cliente').value;
            if (!file || !titulo || !clienteId) { showNotif('danger', 'Cliente, título e arquivo são obrigatórios.'); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                const params = [clienteId, $('#doc-caso').value || null, titulo, e.target.result, file.name, file.type, new Date().toISOString()];
                db.run("INSERT INTO docs (cliente_id, caso_id, titulo, arquivo, nome_arquivo, tipo_arquivo, data) VALUES (?, ?, ?, ?, ?, ?, ?)", params);
                persist();
                showNotif('success', 'Documento salvo!');
                fecharModal('modal-documento');
                renderDocumentos();
            };
            reader.readAsDataURL(file);
        }
        function downloadDoc(id) {
            const res = getRow(`SELECT arquivo, nome_arquivo, tipo_arquivo FROM docs WHERE id=${id}`);
            if(!res) return showNotif('danger', 'Arquivo não encontrado.');
            const link = document.createElement('a');
            link.href = res[0];
            link.download = res[1];
            link.click();
        }

        // --- AGENDA (TAB 4) ---
        function renderAgenda() {
            const dataFiltro = $('#agenda-filtro-data').value;
            const tipoFiltro = $('#agenda-filtro-tipo').value;
            let q = `SELECT a.id, a.titulo, a.datahora, a.status, c.nome, ca.numero, a.tipo_evento, a.local FROM agenda a LEFT JOIN clientes c ON a.cliente_id=c.id LEFT JOIN casos ca ON a.caso_id=ca.id`;
            const cond = [];
            if (dataFiltro) cond.push(`date(a.datahora) = date('${dataFiltro}')`);
            if (tipoFiltro) cond.push(`a.tipo_evento = '${tipoFiltro}'`);
            if(cond.length) q += ' WHERE ' + cond.join(' AND ');
            q += `ORDER BY a.datahora ASC`;
            const rows = db.exec(q)[0]?.values || [];
            const table = $('#tabela-agenda');
            if (!rows.length) { table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum evento encontrado para os filtros selecionados.</p>`; return; }
            table.innerHTML = `<table><thead><tr><th>Evento/Prazo</th><th>Tipo</th><th>Cliente/Caso</th><th>Data/Hora</th><th>Status</th><th>Ações</th></tr></thead><tbody>
        ${rows.map(r => `<tr>
            <td data-label="Evento">${r[1]}</td>
            <td data-label="Tipo">${r[6]}</td>
            <td data-label="Cliente/Caso">${r[4] || ''}${r[5] ? ` / ${r[5]}` : ''}</td>
            <td data-label="Data/Hora">${fmtDateTime(r[2])}</td>
            <td data-label="Status"><span class="badge ${r[3]}">${r[3]}</span></td>
            <td data-label="Ações"><div class="actions">
                <button onclick="abrirModalEvento(${r[0]})" title="Editar"><i class="fa fa-edit"></i></button>
                <button onclick="delRow('agenda', ${r[0]}, renderAgenda)" title="Excluir"><i class="fa fa-trash"></i></button>
            </div></td>
        </tr>`).join('')}</tbody></table>`;
        }
        function abrirModalEvento(id = null) {
            $('#modal-evento form').reset();
            $('#evento-id').value = '';
            populateSelect('evento-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Nenhum');
            $('#evento-caso').innerHTML = '<option value="">Nenhum</option>';

            if (id) {
                const r = getRow(`SELECT * FROM agenda WHERE id=${id}`);
                $('#evento-modal-titulo').innerText = 'Editar Evento';
                $('#evento-id').value = r[0];
                $('#evento-titulo').value = r[3];
                $('#evento-datahora').value = r[4] ? r[4].replace(' ', 'T') : '';
                $('#evento-status').value = r[5];
                $('#evento-desc').value = r[6];
                $('#evento-tipo').value = r[7];
                $('#evento-local').value = r[8];
                if(r[1]) {
                    populateSelect('evento-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Nenhum', r[1]);
                    populateSelect('evento-caso', `SELECT id, numero FROM casos WHERE cliente_id=${r[1]} ORDER BY id DESC`, 'Nenhum', r[2]);
                }
            } else {
                $('#evento-modal-titulo').innerText = 'Novo Evento / Prazo';
            }
            $('#modal-evento').classList.add('active');
        }
        function salvarEvento() {
            const id = $('#evento-id').value;
            const params = [
                $('#evento-cliente').value || null, 
                $('#evento-caso').value || null, 
                $('#evento-titulo').value, 
                $('#evento-datahora').value, 
                $('#evento-status').value, 
                $('#evento-desc').value,
                $('#evento-tipo').value,
                $('#evento-local').value
            ];
            if (!params[2] || !params[3] || !params[6]) return showNotif('danger', 'Título, Data/Hora e Tipo são obrigatórios.');
            
            if (id) {
                db.run("UPDATE agenda SET cliente_id=?, caso_id=?, titulo=?, datahora=?, status=?, descricao=?, tipo_evento=?, local=? WHERE id=?", [...params, id]);
            } else {
                db.run("INSERT INTO agenda (cliente_id, caso_id, titulo, datahora, status, descricao, tipo_evento, local) VALUES (?, ?, ?, ?, ?, ?, ?, ?)", params);
            }
            persist();
            showNotif('success', 'Evento salvo!');
            fecharModal('modal-evento');
            renderAgenda();
            loadDashboard();
        }

        // --- TAREFAS (TAB 5) ---
        function renderTarefas() {
            const status = $('#filtro-tarefa-status').value;
            const prioridade = $('#filtro-tarefa-prioridade').value;
            let q = `SELECT t.id, t.desc, t.status, t.prioridade, t.prazo_data, c.nome, ca.numero FROM tarefas t LEFT JOIN clientes c ON t.cliente_id=c.id LEFT JOIN casos ca ON t.caso_id=ca.id`;
            const cond = [];
            if (status) cond.push(`t.status = '${status}'`);
            if (prioridade) cond.push(`t.prioridade = '${prioridade}'`);
            if(cond.length) q += ' WHERE ' + cond.join(' AND ');
            q += `ORDER BY t.id DESC`;
            const rows = db.exec(q)[0]?.values || [];
            const table = $('#tabela-tarefas');
            if (!rows.length) { table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhuma tarefa encontrada.</p>`; return; }
            table.innerHTML = `<table><thead><tr><th></th><th>Descrição</th><th>Cliente/Caso</th><th>Prazo</th><th>Prioridade</th><th>Ações</th></tr></thead><tbody>
        ${rows.map(r => `<tr>
            <td data-label="Status"><input type="checkbox" onchange="concluirTarefa(${r[0]}, this.checked)" ${r[2] === 'Concluída' ? 'checked' : ''}></td>
            <td data-label="Descrição" style="${r[2] === 'Concluída' ? 'text-decoration:line-through; color:var(--muted-text)' : ''}">${r[1]}</td>
            <td data-label="Cliente/Caso">${r[5] || ''}${r[6] ? ` / ${r[6]}` : ''}</td>
            <td data-label="Prazo">${fmtDate(r[4])}</td>
            <td data-label="Prioridade"><span class="badge ${r[3]}">${r[3]}</span></td>
            <td data-label="Ações"><div class="actions">
                <button onclick="abrirModalTarefa(${r[0]})" title="Editar"><i class="fa fa-edit"></i></button>
                <button onclick="delRow('tarefas', ${r[0]}, renderTarefas)" title="Excluir"><i class="fa fa-trash"></i></button>
            </div></td>
        </tr>`).join('')}</tbody></table>`;
        }
        function abrirModalTarefa(id = null) {
            $('#modal-tarefa form').reset();
            $('#tarefa-id').value = '';
            populateSelect('tarefa-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Nenhum');
            $('#tarefa-caso').innerHTML = '<option value="">Nenhum</option>';

            if (id) {
                const r = getRow(`SELECT * FROM tarefas WHERE id=${id}`);
                $('#tarefa-modal-titulo').innerText = 'Editar Tarefa';
                $('#tarefa-id').value = r[0];
                $('#tarefa-desc').value = r[1];
                $('#tarefa-prioridade').value = r[3];
                $('#tarefa-prazo').value = r[4];
                if(r[5]) {
                    populateSelect('tarefa-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Nenhum', r[5]);
                    populateSelect('tarefa-caso', `SELECT id, numero FROM casos WHERE cliente_id=${r[5]} ORDER BY id DESC`, 'Nenhum', r[6]);
                }
            } else {
                $('#tarefa-modal-titulo').innerText = 'Nova Tarefa';
            }
            $('#modal-tarefa').classList.add('active');
        }
        function salvarTarefa() {
            const id = $('#tarefa-id').value;
            const params = [
                $('#tarefa-desc').value,
                'Pendente',
                $('#tarefa-prioridade').value,
                $('#tarefa-prazo').value,
                $('#tarefa-cliente').value || null,
                $('#tarefa-caso').value || null
            ];
            if (!params[0]) return showNotif('danger', 'A descrição da tarefa é obrigatória.');
            
            if (id) {
                db.run("UPDATE tarefas SET desc=?, prioridade=?, prazo_data=?, cliente_id=?, caso_id=? WHERE id=?", [params[0], params[2], params[3], params[4], params[5], id]);
            } else {
                db.run("INSERT INTO tarefas (desc, status, prioridade, prazo_data, cliente_id, caso_id) VALUES (?, ?, ?, ?, ?, ?)", params);
            }
            persist();
            showNotif('success', 'Tarefa salva!');
            fecharModal('modal-tarefa');
            renderTarefas();
            loadDashboard();
        }
        function concluirTarefa(id, isChecked) {
            const newStatus = isChecked ? 'Concluída' : 'Pendente';
            db.run("UPDATE tarefas SET status = ? WHERE id = ?", [newStatus, id]);
            persist();
            showNotif('success', `Tarefa marcada como ${newStatus.toLowerCase()}.`);
            renderTarefas();
            loadDashboard();
        }

        // --- FINANCEIRO (TAB 6) ---
        function loadFinanceiro() {
            const receitas = single("SELECT IFNULL(SUM(valor), 0) FROM fin WHERE tipo='Receber' AND status_pg='Pago'");
            const despesas = single("SELECT IFNULL(SUM(valor), 0) FROM fin WHERE tipo='Pagar' AND status_pg='Pago'");
            const pendente = single("SELECT IFNULL(SUM(valor), 0) FROM fin WHERE tipo='Receber' AND status_pg='Pendente'");
            
            $('#resumo-financeiro').innerHTML = `
            <div class="card"><i class="icon fa fa-arrow-up" style="color:var(--success)"></i><div class="value">${fmtCurrency(receitas)}</div><div class="label">Total Realizado</div></div>
            <div class="card"><i class="icon fa fa-arrow-down" style="color:var(--danger)"></i><div class="value">${fmtCurrency(despesas)}</div><div class="label">Total Despesas</div></div>
            <div class="card"><i class="icon fa fa-balance-scale" style="color:var(--info)"></i><div class="value">${fmtCurrency(receitas - despesas)}</div><div class="label">Saldo</div></div>
            <div class="card"><i class="icon fa fa-hourglass-half" style="color:var(--warning)"></i><div class="value">${fmtCurrency(pendente)}</div><div class="label">A Receber</div></div>
        `;

            const rows = db.exec("SELECT f.id, f.tipo, f.valor, f.data, f.descricao, f.categoria, f.status_pg, c.nome, ca.numero FROM fin f LEFT JOIN clientes c ON f.cliente_id=c.id LEFT JOIN casos ca ON f.caso_id=ca.id ORDER BY f.data DESC, f.id DESC")[0]?.values || [];
            const table = $('#tabela-financeiro');
            if (!rows.length) { table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum lançamento financeiro.</p>`; return; }
            table.innerHTML = `<table><thead><tr><th>Descrição</th><th>Cliente/Caso</th><th>Data</th><th>Categoria</th><th>Status</th><th>Valor</th><th>Ações</th></tr></thead><tbody>
        ${rows.map(r => `<tr>
            <td data-label="Descrição">${r[4]} <span class="badge ${r[1]}">${r[1]}</span></td>
            <td data-label="Cliente/Caso">${r[7] || ''}${r[8] ? ` / ${r[8]}` : ''}</td>
            <td data-label="Data">${fmtDate(r[3])}</td>
            <td data-label="Categoria">${r[5]}</td>
            <td data-label="Status"><span class="badge ${r[6]}">${r[6]}</span></td>
            <td data-label="Valor" style="color:${r[1] === 'Receber' ? 'var(--success)' : 'var(--danger)'}; font-weight:600;">${fmtCurrency(r[2])}</td>
            <td data-label="Ações"><div class="actions">
                <button onclick="abrirModalFin('${r[1]}', ${r[0]})" title="Editar"><i class="fa fa-edit"></i></button>
                <button onclick="delRow('fin', ${r[0]}, loadFinanceiro)" title="Excluir"><i class="fa fa-trash"></i></button>
            </div></td>
        </tr>`).join('')}</tbody></table>`;
        }
        function abrirModalFin(tipo, id = null) {
            $('#modal-fin form').reset();
            $('#fin-id').value = '';
            $('#fin-tipo').value = tipo;
            $('#fin-titulo').innerText = tipo === 'Receber' ? 'Registrar Receita' : 'Registrar Despesa';
            populateSelect('fin-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Nenhum');
            $('#fin-caso').innerHTML = '<option value="">Nenhum</option>';

            if (id) {
                const r = getRow(`SELECT * FROM fin WHERE id=${id}`);
                $('#fin-id').value = r[0];
                $('#fin-desc').value = r[4];
                $('#fin-categoria').value = r[5];
                $('#fin-valor').value = r[2];
                $('#fin-data').value = r[3];
                $('#fin-status').value = r[6];
                if(r[7]) {
                    populateSelect('fin-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Nenhum', r[7]);
                    populateSelect('fin-caso', `SELECT id, numero FROM casos WHERE cliente_id=${r[7]} ORDER BY id DESC`, 'Nenhum', r[8]);
                }
            } else {
                $('#fin-data').valueAsDate = new Date();
            }
            $('#modal-fin').classList.add('active');
        }
        function salvarFin() {
            const id = $('#fin-id').value;
            const params = [
                $('#fin-tipo').value, 
                $('#fin-valor').value, 
                $('#fin-data').value, 
                $('#fin-desc').value,
                $('#fin-categoria').value,
                $('#fin-status').value,
                $('#fin-cliente').value || null,
                $('#fin-caso').value || null
            ];
            if (!params[1] || !params[2] || !params[3] || !params[4]) return showNotif('danger', 'Descrição, Categoria, Valor e Data são obrigatórios.');
            
            if (id) {
                db.run("UPDATE fin SET tipo=?, valor=?, data=?, descricao=?, categoria=?, status_pg=?, cliente_id=?, caso_id=? WHERE id=?", [...params, id]);
            } else {
                db.run("INSERT INTO fin (tipo, valor, data, descricao, categoria, status_pg, cliente_id, caso_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?)", params);
            }
            persist();
            showNotif('success', 'Lançamento salvo!');
            fecharModal('modal-fin');
            loadFinanceiro();
            loadDashboard();
        }

        // --- RELATÓRIOS (TAB 7) ---
        let reportsChart;
        function loadRelatorios() {
            const q = `SELECT strftime('%Y-%m', data) as mes, SUM(CASE WHEN tipo='Receber' THEN valor ELSE 0 END), SUM(CASE WHEN tipo='Pagar' THEN valor ELSE 0 END) FROM fin WHERE status_pg='Pago' GROUP BY mes ORDER BY mes ASC LIMIT 12`;
            const rows = db.exec(q)[0]?.values || [];
            const labels = rows.map(r => new Date(r[0] + '-02').toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
            const ctx = $('#chart-relatorio').getContext('2d');
            if (reportsChart) reportsChart.destroy();
            reportsChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Receitas', data: rows.map(r => r[1]), backgroundColor: 'rgba(16, 185, 129, 0.7)' }, { label: 'Despesas', data: rows.map(r => r[2]), backgroundColor: 'rgba(239, 68, 68, 0.7)' }] }, options: { scales: { y: { beginAtZero: true } } } });
        }
        function exportarCSV(tableName) {
            const res = db.exec(`SELECT * FROM ${tableName}`)[0];
            if (!res) return showNotif('danger', 'Não há dados para exportar.');
            let csvContent = "data:text/csv;charset=utf-8," + res.columns.join(";") + "\n" + res.values.map(e => e.map(v => `\"${v}\"`).join(";")).join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `${tableName}_export_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        /* ------------- INICIALIZAÇÃO ------------- */
        function renderAll() {
            // Pré-popula os filtros para a primeira renderização
            populateSelect('doc-filtro-cliente', 'SELECT id, nome FROM clientes ORDER BY nome', 'Todos os clientes');
            populateSelect('doc-filtro-caso', 'SELECT id, numero FROM casos ORDER BY id DESC', 'Todos os casos');
            // Renderiza a primeira aba
            loadDashboard();
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem(KEY_USER)) {
                // A tela de login já oferece a opção de criar
            } else {
                // Se já houver login, pode tentar logar direto (opcional)
                // checkLogin(); 
            }
        });
    </script>
</body>

</html>
